<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Usuário - CLÍNICA ETEMFL</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>

  <style>
    :root{
      --primary:#28a745;
      --accent:#ffc107;
      --dark:#155724;
      --light:#f8f9fa;
      --white:#ffffff;
      --muted:#6c757d;
      --border:#e6e6e6;
      --danger:#dc3545;
      --blue:#007bff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:Inter, "Segoe UI", Tahoma, Helvetica, Arial; background:var(--light); color:#222; line-height:1.3}
    .app { display:flex; min-height:100vh; gap:18px; }
    .app.blocked { filter: blur(3px); pointer-events:none; user-select:none; }
    .sidebar { width:300px; background:var(--dark); color:#fff; padding:20px; display:flex; flex-direction:column; }
    .logo { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .logo .icon { width:44px; height:44px; border-radius:8px; background:var(--accent); display:flex; align-items:center; justify-content:center; color:var(--dark); font-weight:700 }
    .logo .brand-title{ font-weight:800 }
    .logo .brand-sub { font-size:0.85rem; opacity:.9 }
    .nav { margin-top:8px; display:flex; flex-direction:column; gap:6px; }
    .nav a { color:#fff; text-decoration:none; padding:10px; border-radius:8px; display:flex; gap:8px; align-items:center; }
    .nav a:hover, .nav a.active { background: rgba(255,255,255,0.06); }
    .badge{ background:var(--accent); color:var(--dark); font-weight:800; border-radius:10px; padding:0 6px; margin-left:6px; font-size:0.75rem; }
    .main { flex:1; padding:22px; }
    .card { background:var(--white); padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); margin-bottom:16px; }
    h1{ color:var(--primary); font-size:1.2rem; margin-bottom:12px; }
    .headline-lg{ font-size:1.1rem; font-weight:900; }
    .headline-day{ font-weight:900; font-size:1.08rem; }
    .form-group{ margin-bottom:10px; }
    label{ display:block; font-weight:700; margin-bottom:6px; }
    input[type="text"], input[type="date"], input[type="number"], input[type="password"], select, textarea { width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; font-size:0.95rem; }
    button{ cursor:pointer; border:none; border-radius:8px; padding:8px 12px; font-weight:700; }
    .btn { background:var(--primary); color:#fff; }
    .btn-muted { background:#f0f0f0; color:#222; }
    .btn-danger { background:var(--danger); color:#fff; }
    .btn-blue { background:var(--blue); color:#fff; }
    .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
    .spec-card { padding:12px; border:1px solid var(--border); border-radius:8px; background:#fff; }
    table{ width:100%; border-collapse:collapse; font-size:0.95rem; }
    th,td{ padding:10px; border-bottom:1px solid var(--border); text-align:left; vertical-align:middle; }
    .actions{ display:flex; gap:8px; justify-content:flex-end; }
    .status{ padding:6px 10px; border-radius:12px; font-weight:800; font-size:0.85rem; }
    .pending{ background:#fff3cd; color:#856404; }
    .confirmed{ background:#d4edda; color:#155724; }
    .canceled{ background:#f8d7da; color:#721c24; }
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; opacity:0; visibility:hidden; transition:all .12s; }
    .overlay.show{ opacity:1; visibility:visible; }
    .modal{ width:960px; max-width:96%; max-height:90vh; overflow:auto; background:#fff; border-radius:10px; padding:16px; }
    .small{ font-size:0.85rem; color:#6c757d; }
    .muted{ color:var(--muted); }
    .contact-card { background: #fff; color: #000 !important; padding: 16px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 6px 18px rgba(0,0,0,0.08); margin-top:20px; }
    .contact-card * { color: #000 !important; }
    .contact-card .clinic-name { font-weight:800; font-size:1rem; }
    .contact-card .clinic-line { font-size:0.92rem; margin-top:6px; }
    .login-container { position:fixed; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(2px); display:none; align-items:center; justify-content:center; z-index:10000; }
    .login-box { width:420px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.08); }
    .tabs { display:flex; gap:6px; margin-bottom:12px; }
    .tab { flex:1; text-align:center; padding:10px; border-radius:8px; cursor:pointer; border:1px solid var(--border); background:#fff; }
    .tab.active { background: linear-gradient(90deg,var(--primary),#2dbb5a); color:#fff; }
    .field-inline { display:flex; gap:8px; }
    #regNome{ width:100%; }

    @media(max-width:900px){
      .sidebar{ display:none }
      .grid{ grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); }
    }

    pre.history { white-space: pre-wrap; background:#f7f7f7; padding:12px; border-radius:8px; border:1px solid var(--border); margin-bottom:8px; color:#222; }
  </style>
</head>
<body>

  <div id="loginScreen" class="login-container" style="display:none">
    <div class="login-box">
      <div class="tabs" role="tablist">
        <div id="tabLogin" class="tab active" role="tab">Login</div>
        <div id="tabRegister" class="tab" role="tab">Cadastrar</div>
      </div>

      <div id="loginPane">
        <div class="form-group"><label>CPF</label><input id="loginCpf" placeholder="000.000.000-00" /></div>
        <div class="form-group"><label>Cartão SUS</label><input id="loginSus" placeholder="000.0000.0000.0000" /></div>
        <div class="form-group"><label>Senha</label><input id="loginSenha" type="password" placeholder="Digite sua senha" /></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btnLogin" class="btn">Entrar</button>
        </div>
        <div class="small" style="margin-top:10px">Ao entrar, você verá seus agendamentos e poderá agendar novas consultas (somente em vagas ofertadas pela clínica).</div>
      </div>

      <div id="registerPane" style="display:none">
        <div class="form-group"><label>Nome completo</label><input id="regNome" /></div>
        <div class="field-inline">
          <div style="flex:1" class="form-group"><label>Data de nascimento</label><input id="regNascimento" type="date" /></div>
          <div style="flex:1" class="form-group"><label>CPF</label><input id="regCpf" maxlength="14" placeholder="000.000.000-00" /></div>
        </div>
        <div class="field-inline">
          <div style="flex:1" class="form-group"><label>Cartão SUS</label><input id="regSus" maxlength="19" placeholder="000.0000.0000.0000" /></div>
          <div style="flex:1" class="form-group"><label>Bairro</label>
            <select id="regBairro"></select>
          </div>
        </div>
        <div class="form-group"><label>Senha</label><input id="regSenha" type="password" placeholder="Crie uma senha" /></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btnRegister" class="btn">Cadastrar</button>
        </div>
        <div class="small" style="margin-top:10px">Todos os campos são obrigatórios. Não é permitido cadastrar com CPF ou Cartão SUS já existentes.</div>
      </div>
    </div>
  </div>

  <div id="app" class="app" style="display:none">

    <aside class="sidebar" role="navigation" aria-label="Menu principal">
      <div class="logo">
        <div class="icon" id="brandIcon">U</div>
        <div>
          <div id="brandTitle" class="brand-title">Plataforma</div>
          <div id="brandSub" class="brand-sub">Usuário</div>
        </div>
      </div>

      <nav class="nav" aria-label="Navegação">
        <a href="#" class="active" data-page="dashboard"><i class="fas fa-home"></i> PAINEL DE VAGAS</a>
        <a href="#" data-page="comunicados" id="linkComunicados"><i class="fas fa-bell"></i> Comunicados <span id="comBadge" class="badge" style="display:none">0</span></a>
        <a href="#" data-page="agendar"><i class="fas fa-calendar-plus"></i> Agendar Consulta</a>
        <a href="#" data-page="meus-agendamentos"><i class="fas fa-calendar-check"></i> Meus Agendamentos</a>
        <a href="#" data-page="meu-perfil"><i class="fas fa-user"></i> Meu Perfil</a>
        <a href="#" data-page="historico"><i class="fas fa-history"></i> Histórico</a>
        <a href="#" data-page="contato"><i class="fas fa-hospital"></i> Contato da Clínica</a>
        <a href="#" id="btnLogout"><i class="fas fa-sign-out-alt"></i> Sair</a>
      </nav>

      <div class="contact-card" id="clinicContact">
        <div class="clinic-name" id="clinicName">— Sem dados cadastrados —</div>
        <div class="clinic-line" id="clinicAddress"></div>
        <div class="clinic-line" id="clinicPhone"></div>
      </div>
    </aside>

    <main class="main">

      <section id="dashboard" class="card">
        <h1>PAINEL — Especialidades com Vagas</h1>
        <div id="vagasGrid" class="grid"></div>
        <div class="small" style="margin-top:8px">Selecione uma especialidade para ver os especialistas e horários disponíveis da semana subsequente.</div>
      </section>

      <section id="comunicados" class="card" style="display:none">
        <h1>Comunicados da Clínica</h1>
        <div id="comList"></div>
        <div class="small" style="margin-top:8px" id="comHint">Somente comunicados direcionados ao seu setor/bairro ou gerais da clínica serão exibidos.</div>
      </section>

      <section id="agendar" class="card" style="display:none">
        <h1>Agendar Consulta</h1>

        <div class="form-group">
          <label>Especialidade</label>
          <select id="selEspecialidade"><option value="">-- Escolha --</option></select>
        </div>

        <div class="form-group">
          <label>Especialista</label>
          <select id="selEspecialista"><option value="">-- Escolha --</option></select>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
          <button id="btnMostrarVagas" class="btn">Mostrar vagas (semana subsequente)</button>
          <div id="msgVagas" class="small" style="margin-left:8px;color:#555"></div>
        </div>

        <div id="vagasResultados"></div>
      </section>

      <section id="meus-agendamentos" class="card" style="display:none">
        <h1>Meus Agendamentos</h1>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
          <div><label>Data inicial</label><input id="filterFrom" type="date" /></div>
          <div><label>Data final</label><input id="filterTo" type="date" /></div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-left:8px">
            <button id="btnFilterMy" class="btn">Aplicar</button>
            <button id="btnClearMy" class="btn-muted">Limpar</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Especialidade</th>
              <th>Especialista</th>
              <th>Data da Consulta</th>
              <th>Hora</th>
              <th>Status</th>
              <th style="width:220px">Ações</th>
            </tr>
          </thead>
          <tbody id="myAgendamentosTbody"></tbody>
        </table>
      </section>

      <section id="meu-perfil" class="card" style="display:none">
        <h1>Meu Perfil</h1>
        <div class="form-group"><label>Nome</label><input id="pfNome" disabled /></div>
        <div style="display:flex;gap:8px;">
          <div style="flex:1" class="form-group"><label>Data de Nascimento</label><input id="pfNascimento" type="date" disabled /></div>
          <div style="flex:1" class="form-group"><label>CPF</label><input id="pfCpf" disabled /></div>
        </div>
        <div style="display:flex;gap:8px;">
          <div style="flex:1" class="form-group"><label>Cartão SUS</label><input id="pfSus" disabled /></div>
          <div style="flex:1" class="form-group"><label>Bairro</label><input id="pfBairro" disabled /></div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
          <button id="btnSolicitarAlteracao" class="btn-muted">Solicitar alteração (clínica)</button>
        </div>
        <div class="small" style="margin-top:10px">Se precisar alterar seus dados, envie uma solicitação à clínica — Em 72 horas faça um novo cadastro — Se não liberado procure a clinica aqual você é atendido(a). </div>
      </section>

      <section id="historico" class="card" style="display:none">
        <h1>Histórico</h1>
        <div style="display:flex;gap:8px;align-items:end;margin-bottom:10px;">
          <div><label>Data início</label><input id="histFrom" type="date" /></div>
          <div><label>Data fim</label><input id="histTo" type="date" /></div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button id="btnAplicarHistUser" class="btn">Aplicar</button>
            <button id="btnLimparHistUser" class="btn-muted">Limpar</button>
          </div>
        </div>
        <div id="histUserList"></div>
      </section>

      <section id="contato" class="card" style="display:none">
        <h1>Contato da Clínica</h1>
        <div class="contact-card">
          <div class="clinic-name" id="clinicName2">— Sem dados cadastrados —</div>
          <div class="clinic-line" id="clinicAddress2"></div>
          <div class="clinic-line" id="clinicPhone2"></div>
        </div>
      </section>

    </main>
  </div>

  <div id="vagasModal" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="vagasModalTitle">Vagas</h3>
      <div id="vagasModalContent" style="margin-top:8px;"></div>
      <hr />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button id="btnCloseVagasUser" class="btn-muted">Fechar</button>
      </div>
    </div>
  </div>

  <div id="ticketModal" class="overlay" aria-hidden="true">
    <div class="modal">
      <h3>Comprovante</h3>
      <div id="ticketBody" style="margin-top:8px;"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;">
        <button id="btnPrintTicket" class="btn-blue">Imprimir / Salvar PDF</button>
        <button id="btnCloseTicket" class="btn-muted">Fechar</button>
      </div>
    </div>
  </div>
  <script>

    const LS = {
      PAC: 'db_pacientes_v3',
      ESP: 'db_especialistas_v3',
      AG:  'db_agendamentos_v3',
      CFG: 'db_config_v3',
      HIST:'db_history_v1',
      COM: 'db_comunicados_v1',
      SESSION: 'session_user_v1'
    };

    const pad2 = n => (n < 10 ? '0' + n : '' + n);
    function formatDateTime(iso){
      if(!iso) return '';
      const d = new Date(iso);
      return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}, ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }

    function formatDateDDMMYYYY(isoOrDate){
      if(!isoOrDate) return '';
      const d = (typeof isoOrDate === 'string') ? new Date(isoOrDate + 'T00:00:00') : new Date(isoOrDate);
      return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    }

    function toISODateString(d){
      const date = new Date(d);
      date.setHours(0,0,0,0);
      return `${date.getFullYear()}-${pad2(date.getMonth()+1)}-${pad2(date.getDate())}`;
    }

    function read(key){
      try { return JSON.parse(localStorage.getItem(key)) || []; } catch(e){ return []; }
    }

    function write(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
    function genId(){ return 'id_' + Math.random().toString(36).slice(2,10); }
    function nowISO(){ return new Date().toISOString(); }
    function generateSlots(startHour, endHour, interval=15){
      const slots = [];
      for(let h=startHour; h<endHour; h++){
        for(let m=0; m<60; m+=interval) slots.push(`${pad2(h)}:${pad2(m)}`);
      }
      return slots;
    }

    const MORNING_SLOTS = generateSlots(7,12,15);
    const AFTERNOON_SLOTS = generateSlots(12,17,15);
    function getLimitedSlots(shift, limit){
      if(limit <= 0) return [];
      if(shift === 'manhã') return MORNING_SLOTS.slice(0, limit);
      if(shift === 'tarde') return AFTERNOON_SLOTS.slice(0, limit);
      return [];
    }

    const SETORES = {
      A1: ['Centro','São Francisco','Nossa Senhora das Dores','Nossa Senhora de Fátima','Nossa Senhora de Lourdes','Salgado','Maurício de Nassau','Divinópolis','Riachão','Santa Rosa'],
      B2: ['Cedro','Indianópolis','Morada do Sol','Jardim Pinheiros','Serraria','Vila do Aeroporto','Agamenon Magalhães','Vassoural','Rendeiras','Cidade Alta'],
      C3: ['São João da EscóCIA','Petrópolis','Kennedy','Boa Vista','Morro do Bom Jesus','Loteamento São Francisco','Loteamento Recanto do Sol'],
      D4: ['José Carlos de Oliveira','José Rosa','Cidade Jardim','Novo Horizonte','Santa Cruz','Caruaru Velho','Loteamento Cruzeiro','Loteamento Planalto','Loteamento Vila Bela','Loteamento Cidade Nova'],
      E5: ['Distrito Industrial','Vila Kennedy','Cajá','Loteamento Cajá Extensão','Loteamento Novo Cajá','Loteamento Morada Nova','Sítio Farias','Sítio Salgado','Sítio Lucas','Sítio Riacho Doce']
    };

    function populateBairrosSelect(){
      const sel = document.getElementById('regBairro');
      sel.innerHTML = '<option value="">-- Selecione o bairro --</option>';
      Object.keys(SETORES).forEach(setor => {
        SETORES[setor].forEach(b => {
          const opt = document.createElement('option');
          opt.value = b + '||' + setor;
          opt.textContent = `${b} (${setor})`;
          sel.appendChild(opt);
        });
      });
    }

    function calcularSetorPorBairro(bairroRaw){
      if(!bairroRaw) return '';
      if(bairroRaw.includes('||')) return bairroRaw.split('||')[1];
      const b = bairroRaw.toLowerCase();
      for(const setor in SETORES){
        if(SETORES[setor].some(name => name.toLowerCase() === b || b.includes(name.toLowerCase()))) return setor;
      }
      return 'Não identificado';
    }

    function initDefaults(){
      if(localStorage.getItem(LS.CFG) === null) write(LS.CFG, { nomeClinica:'', endereco:'', telefone:'', setor:'', masterHash: null });
      if(!Array.isArray(read(LS.ESP))) write(LS.ESP, []);
      if(!Array.isArray(read(LS.PAC))) write(LS.PAC, []);
      if(!Array.isArray(read(LS.AG))) write(LS.AG, []);
      if(!Array.isArray(read(LS.HIST))) write(LS.HIST, []);  
      if(!Array.isArray(read(LS.COM))) write(LS.COM, []);
    }

    function addHistory(type, actor, summary, payload){
      const hist = read(LS.HIST);
      hist.push({ id: genId(), type, actor, timestamp: nowISO(), summary, payload });
      write(LS.HIST, hist);
    }

    function renderClinicContact(){
      const cfgRaw = localStorage.getItem(LS.CFG);
      let cfg = {};
      if(cfgRaw){ try { cfg = JSON.parse(cfgRaw) || {}; } catch(e){ cfg={}; } }
      const nameEl = document.getElementById('clinicName');
      const addrEl = document.getElementById('clinicAddress');
      const phoneEl = document.getElementById('clinicPhone');
      const nameEl2 = document.getElementById('clinicName2');
      const addrEl2 = document.getElementById('clinicAddress2');
      const phoneEl2 = document.getElementById('clinicPhone2');
      nameEl.textContent = cfg.nomeClinica || '— Sem dados cadastrados —';
      addrEl.textContent = cfg.endereco || '';
      phoneEl.textContent = cfg.telefone || '';
      if(nameEl2) nameEl2.textContent = cfg.nomeClinica || '— Sem dados cadastrados —';
      if(addrEl2) addrEl2.textContent = cfg.endereco || '';
      if(phoneEl2) phoneEl2.textContent = cfg.telefone || '';
    }

    function getAvailabilityForSpecialistOnDate(especialista, dateISO){
      if(!especialista || !Array.isArray(especialista.dias) || !especialista.dias.length) return [];
      const dateObj = new Date(dateISO + 'T00:00:00');
      const dow = dateObj.getDay();
      if(!especialista.dias.includes(dow)) return [];
      let allowed = [];
      if(especialista.turno === 'manhã' || especialista.turno === 'ambos'){
        allowed = allowed.concat(getLimitedSlots('manhã', especialista.vagasManha || 0));
      }
      if(especialista.turno === 'tarde' || especialista.turno === 'ambos'){
        allowed = allowed.concat(getLimitedSlots('tarde', especialista.vagasTarde || 0));
      }
      const ags = read(LS.AG);
      const taken = ags.filter(a => a.especialistaId === especialista.id && a.data === dateISO && a.status !== 'Cancelado').map(a => a.hora);
      return allowed.filter(s => !taken.includes(s));
    }

    function getMonday(date){
      const d = new Date(date);
      const day = d.getDay();
      const diff = (day === 0) ? -6 : (1 - day);
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }

    function getWeekNextStart(){
      const monday = getMonday(new Date());
      const nextWeekStart = new Date(monday); nextWeekStart.setDate(monday.getDate() + 7);
      nextWeekStart.setHours(0,0,0,0);
      return nextWeekStart;
    }

    function getAvailabilityForSpecialistWeek(especialista){
      const start = getWeekNextStart();
      const result = [];
      for(let i=0;i<7;i++){
        const day = new Date(start); day.setDate(start.getDate() + i);
        const iso = toISODateString(day);
        const dowName = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'][day.getDay()];
        const slots = getAvailabilityForSpecialistOnDate(especialista, iso);
        result.push({ dateISO: iso, dowName, dowIdx: day.getDay(), slots });
      }
      return result;
    }

    function findAvailabilityForSpecialtyNextWeek(especialidade){
      const specs = read(LS.ESP).filter(s => s.especialidade === especialidade && s.ativo !== false);
      const result = {};
      specs.forEach(sp => {
        result[sp.id] = { especialista: sp, week: getAvailabilityForSpecialistWeek(sp) };
      });
      return result;
    }

    function getFirstAvailableFromWeek(week){
      for(const d of week){
        if(d.slots && d.slots.length) return { dateISO: d.dateISO, time: d.slots[0], dowName: d.dowName, dowIdx: d.dowIdx };
      }
      return null;
    }

    function renderVagasPanelForUser(){
      const grid = document.getElementById('vagasGrid');
      grid.innerHTML = '';
      const specs = read(LS.ESP).filter(s => s.ativo !== false);
      if(!specs.length){
        grid.innerHTML = '<div class="card small">Nenhuma especialidade cadastrada pela clínica.</div>';
        return;
      }
      const bySpec = {};
      specs.forEach(s => {
        bySpec[s.especialidade] = bySpec[s.especialidade] || [];
        bySpec[s.especialidade].push(s);
      });
      Object.keys(bySpec).forEach(especialidade => {
        const specsList = bySpec[especialidade];
        let total = 0;
        const nextWeekStart = getWeekNextStart();
        for(let i=0;i<7;i++){
          const day = new Date(nextWeekStart); day.setDate(nextWeekStart.getDate() + i);
          const iso = toISODateString(day);
          specsList.forEach(sp => total += getAvailabilityForSpecialistOnDate(sp, iso).length);
        }
        const card = document.createElement('div');
        card.className = 'spec-card card';
        card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong style="text-transform:capitalize">${especialidade}</strong></div>
          <div class="small">Vagas (7d)</div>
        </div>
        <div style="font-weight:800;font-size:1.3rem">${total}</div>
        <div style="display:flex;justify-content:flex-end;margin-top:6px"><button class="btn" data-especialidade="${especialidade}">Abrir</button></div>`;
        card.querySelector('button').addEventListener('click', ()=> {
          document.querySelector('[data-page="agendar"]').click();
          document.getElementById('selEspecialidade').value = especialidade;
          populateEspecialistasForSelected();
          document.getElementById('btnMostrarVagas').click();
        });
        grid.appendChild(card);
      });
    }

    function populateEspecialidadesSelect(){
      const sel = document.getElementById('selEspecialidade');
      sel.innerHTML = '<option value="">-- Escolha --</option>';
      const specs = read(LS.ESP).filter(s => s.ativo !== false);
      const set = new Set(specs.map(s => s.especialidade));
      Array.from(set).sort().forEach(espec => {
        const opt = document.createElement('option'); opt.value = espec; opt.textContent = espec; sel.appendChild(opt);
      });
    }

    function populateEspecialistasForSelected(){
      const especialidade = document.getElementById('selEspecialidade').value;
      const sel = document.getElementById('selEspecialista');
      sel.innerHTML = '<option value="">-- Escolha --</option>';
      if(!especialidade) return;
      const specs = read(LS.ESP).filter(s => s.especialidade === especialidade && s.ativo !== false);
      specs.forEach(s => {
        const week = getAvailabilityForSpecialistWeek(s);
        const first = getFirstAvailableFromWeek(week);
        const label = first
          ? `${s.nome} — ${s.turno} — Reservar ${first.time} (primeira vaga)`
          : `${s.nome} — ${s.turno} — sem vagas na semana`;
        const opt = document.createElement('option'); opt.value = s.id; opt.textContent = label;
        sel.appendChild(opt);
      });
    }

    function maskCpf(v){ return v.replace(/\D/g,'').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2').slice(0,14); }
    function maskSus(v){ return v.replace(/\D/g,'').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{4})(\d)/,'$1.$2').replace(/(\d{4})(\d)/,'$1.$2').slice(0,19); }
    function registerUser(){
      const nome = document.getElementById('regNome').value.trim();
      const nascimento = document.getElementById('regNascimento').value;
      const cpfRaw = document.getElementById('regCpf').value.trim();
      const susRaw = document.getElementById('regSus').value.trim();
      const bairroVal = document.getElementById('regBairro').value;
      const senha = document.getElementById('regSenha').value.trim();
      if(!nome || !nascimento || !cpfRaw || !susRaw || !bairroVal || !senha){
        alert('Preencha todos os campos obrigatórios.');
        return;
      }
      const cpf = cpfRaw.replace(/\D/g,'');
      const sus = susRaw.replace(/\D/g,'');
      const pacs = read(LS.PAC);
      if(pacs.some(p => p.cpf === cpf)) { alert('Já existe um usuário cadastrado com este CPF.'); return; }
      if(sus && pacs.some(p => p.sus === sus)) { alert('Já existe um usuário cadastrado com este Cartão SUS.'); return; }

      const setor = calcularSetorPorBairro(bairroVal);
      const cfg = JSON.parse(localStorage.getItem(LS.CFG) || '{}');
      let clinicSnapshot = {};
      if(cfg && cfg.setor && cfg.setor === setor){
        clinicSnapshot = cfg;
      } else {
        clinicSnapshot = {};
      }

      const paciente = {
        id: genId(),
        nome,
        nascimento,
        cpf,
        sus,
        bairro: bairroVal.includes('||') ? bairroVal.split('||')[0] : bairroVal,
        setor,
        senha, 
        createdBy: 'usuario',
        createdAt: nowISO(),
        notifications: [],
        comunicadosLidos: [],
        clinicAssigned: clinicSnapshot || {}
      };
      pacs.push(paciente);
      write(LS.PAC, pacs);
      addHistory('paciente','Usuário',`Cadastro de paciente (usuário): ${nome}`, { paciente });
      alert('Cadastro realizado com sucesso. Agora você pode efetuar login.');
      localStorage.setItem(LS.SESSION, JSON.stringify({ pacienteId: paciente.id }));
      loadUserSessionAndShowApp();
    }

    function loginUser(){
      const cpfRaw = document.getElementById('loginCpf').value.trim();
      const susRaw = document.getElementById('loginSus').value.trim();
      const senha = document.getElementById('loginSenha').value.trim();
      if(!cpfRaw || !susRaw || !senha){ alert('Informe CPF, Cartão SUS e Senha para entrar.'); return; }
      const cpf = cpfRaw.replace(/\D/g,'');
      const sus = susRaw.replace(/\D/g,'');
      const pacs = read(LS.PAC);
      const user = pacs.find(p => p.cpf === cpf && p.sus === sus);
      if(!user){ alert('Usuário não encontrado. Verifique CPF e Cartão SUS.'); return; }
      if(!user.senha || user.senha !== senha){ alert('Senha incorreta.'); return; }
      localStorage.setItem(LS.SESSION, JSON.stringify({ pacienteId: user.id }));
      loadUserSessionAndShowApp();
    }

    function logout(){
      localStorage.removeItem(LS.SESSION);
      window.location.reload();
    }

    function getCurrentUser(){
      const s = localStorage.getItem(LS.SESSION);
      if(!s) return null;
      try {
        const session = JSON.parse(s);
        const pacs = read(LS.PAC);
        return pacs.find(p => p.id === session.pacienteId) || null;
      } catch(e){ return null; }
    }

    function updateBrandWithUser(){
      const user = getCurrentUser();
      const t = document.getElementById('brandTitle');
      const s = document.getElementById('brandSub');
      const ic = document.getElementById('brandIcon');
      if(!user){ t.textContent='Plataforma'; s.textContent='Usuário'; ic.textContent='U'; return; }
      const partes = (user.nome || '').trim().split(/\s+/);
      const primeiro = partes[0] || '';
      const ultimo  = partes[partes.length - 1] || '';
      t.textContent = (primeiro + ' ' + ultimo).trim();
      s.textContent = user.setor ? ('Setor ' + user.setor) : '—';
      const iniciais = (primeiro[0]||'') + (ultimo[0]||'');
      ic.textContent = iniciais.toUpperCase() || 'U';
    }

    function loadUserSessionAndShowApp(){
      const user = getCurrentUser();
      const login = document.getElementById('loginScreen');
      const app = document.getElementById('app');
      if(!user){
        login.style.display = 'flex';
        app.style.display = 'flex';
        app.classList.add('blocked');
        renderClinicContact();
        populateBairrosSelect();
        return;
      }
      login.style.display = 'none';
      app.style.display = 'flex';
      app.classList.remove('blocked');
      renderClinicContact();
      renderVagasPanelForUser();
      populateEspecialidadesSelect();
      populateBairrosSelect();
      renderPerfilUser();
      updateBrandWithUser();
      refreshComunicadosBadge();
      showPage('dashboard');
      checkNewComunicadosAndNotify();
    }

    function renderPerfilUser(){
      const user = getCurrentUser();
      if(!user) return;
      document.getElementById('pfNome').value = user.nome || '';
      document.getElementById('pfNascimento').value = user.nascimento || '';
      document.getElementById('pfCpf').value = formatCPFDisplay(user.cpf);
      document.getElementById('pfSus').value = formatSUSDisplay(user.sus);
      document.getElementById('pfBairro').value = user.bairro || '';
    }

    document.getElementById('tabLogin').addEventListener('click', ()=>{
      document.getElementById('tabLogin').classList.add('active'); document.getElementById('tabRegister').classList.remove('active');
      document.getElementById('loginPane').style.display = 'block'; document.getElementById('registerPane').style.display = 'none';
    });

    document.getElementById('tabRegister').addEventListener('click', ()=>{
      document.getElementById('tabRegister').classList.add('active'); document.getElementById('tabLogin').classList.remove('active');
      document.getElementById('registerPane').style.display = 'block'; document.getElementById('loginPane').style.display = 'none';
    });

    document.getElementById('btnRegister').addEventListener('click', registerUser);
    document.getElementById('btnLogin').addEventListener('click', loginUser);
    document.getElementById('btnLogout').addEventListener('click', (e)=>{ e.preventDefault(); logout(); });
    document.getElementById('regCpf').addEventListener('input', e => e.target.value = maskCpf(e.target.value));
    document.getElementById('regSus').addEventListener('input', e => e.target.value = maskSus(e.target.value));
    document.getElementById('loginCpf').addEventListener('input', e => e.target.value = maskCpf(e.target.value));
    document.getElementById('loginSus').addEventListener('input', e => e.target.value = maskSus(e.target.value));

    function formatCPFDisplay(cpf){
      if(!cpf) return '-';
      const s = cpf.toString().replace(/\D/g,'').padStart(11,'0');
      return `${s.slice(0,3)}.${s.slice(3,6)}.${s.slice(6,9)}-${s.slice(9,11)}`;
    }
    function formatSUSDisplay(sus){
      if(!sus) return '-';
      const s = sus.toString().replace(/\D/g,'');
      if(s.length < 15) return s;
      return `${s.slice(0,3)}.${s.slice(3,7)}.${s.slice(7,11)}.${s.slice(11,15)}`;
    }

    document.getElementById('selEspecialidade').addEventListener('change', ()=>{
      populateEspecialistasForSelected();
      document.getElementById('vagasResultados').innerHTML = '';
      document.getElementById('msgVagas').textContent = '';
    });

    document.getElementById('btnMostrarVagas').addEventListener('click', ()=>{
      const espec = document.getElementById('selEspecialidade').value;
      const espId = document.getElementById('selEspecialista').value;
      if(!espec){ alert('Escolha uma especialidade.'); return; }
      const avail = findAvailabilityForSpecialtyNextWeek(espec);

      let any = false;
      for(const k in avail){
        const wk = avail[k].week;
        for(const d of wk){ if(d.slots && d.slots.length) { any = true; break; } }
        if(any) break;
      }
      if(!any){
        document.getElementById('vagasResultados').innerHTML = `<div class="small">Não há vagas na semana subsequente para esta especialidade. Tente novamente a partir da próxima segunda-feira.</div>`;
        return;
      }

      const resultsDiv = document.getElementById('vagasResultados');
      resultsDiv.innerHTML = '';

      if(espId){
        const rec = avail[espId];
        if(!rec){ resultsDiv.innerHTML = '<div class="small">Especialista não encontrado ou sem vagas.</div>'; return; }
        const first = getFirstAvailableFromWeek(rec.week);
        const totalSemana = rec.week.reduce((s,d)=> s + d.slots.length,0);
        const header = document.createElement('div');
        header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center'; header.style.marginBottom='8px';
        header.innerHTML = `<div class="headline-lg">${rec.especialista.nome} — ${first ? (first.dowName.toLowerCase() + ' — ' + formatDateDDMMYYYY(first.dateISO)) : 'semana'}</div>
                            <div class="small">${rec.especialista.turno} • Vagas (semana): ${totalSemana}</div>`;
        resultsDiv.appendChild(header);
        resultsDiv.appendChild(renderSpecialistWeekAvailability(rec.especialista, rec.week));
      } else {
        for(const k in avail){
          const rec = avail[k];
          const totalSemana = rec.week.reduce((s,d)=> s + d.slots.length,0);
          const first = getFirstAvailableFromWeek(rec.week);

          const el = document.createElement('div');
          el.style.border = '1px solid var(--border)';
          el.style.padding = '10px';
          el.style.marginBottom = '8px';

          const turnoFmt = rec.especialista.turno === 'ambos' ? 'manhã/tarde' : rec.especialista.turno;

          el.innerHTML =
            `<div style="display:flex;justify-content:space-between;align-items:center;">
               <div class="headline-lg">${rec.especialista.nome} — ${first ? (first.dowName.toLowerCase() + ' — ' + formatDateDDMMYYYY(first.dateISO)) : 'semana'}</div>
               <div class="small">${turnoFmt} • Vagas (semana): ${totalSemana}</div>
             </div>`;

          el.appendChild(renderSpecialistWeekAvailabilityInline(rec.especialista, rec.week));
          resultsDiv.appendChild(el);
        }
      }
    });

    function renderSpecialistWeekAvailability(especialista, weekData){
      const container = document.createElement('div');
      weekData.forEach(day => {
        const box = document.createElement('div');
        box.style.borderBottom = '1px dashed var(--border)';
        box.style.padding = '8px 0';
        box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
                           <div class="headline-day">${day.dowName} — ${formatDateDDMMYYYY(day.dateISO)}</div>
                           <div class="small">Horários: ${day.slots.length}</div>
                         </div>`;
        if(day.slots.length){
          const slotsDiv = document.createElement('div'); 
          slotsDiv.style.marginTop='8px'; 
          slotsDiv.style.display='flex'; 
          slotsDiv.style.flexWrap='wrap'; 
          slotsDiv.style.gap='8px';
          day.slots.forEach((slot, idx) => {
            const b = document.createElement('button');
            b.className = 'btn';
            b.style.padding = '6px 8px';
            b.textContent = `Reservar ${slot}` + (idx === 0 ? ' (primeira vaga)' : '');
            b.addEventListener('click', ()=> confirmCreateAppointment(especialista, day.dateISO, slot));
            slotsDiv.appendChild(b);
          });
          box.appendChild(slotsDiv);
        } else {
          const none = document.createElement('div'); none.className='small'; none.textContent='Sem horários disponíveis neste dia'; box.appendChild(none);
        }
        container.appendChild(box);
      });
      return container;
    }

    function renderSpecialistWeekAvailabilityInline(especialista, weekData){
      const container = document.createElement('div');
      weekData.forEach(day => {
        if(day.slots.length){
          const row = document.createElement('div');
          row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginTop='8px';
          const left = document.createElement('div'); left.innerHTML = `<div class="small">${day.dowName} — ${formatDateDDMMYYYY(day.dateISO)}</div>`;
          const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
          const btn = document.createElement('button'); btn.className='btn'; btn.textContent = `Reservar ${day.slots[0]} (primeira vaga)`;
          btn.addEventListener('click', ()=> confirmCreateAppointment(especialista, day.dateISO, day.slots[0]));
          right.appendChild(btn);
          row.appendChild(left); row.appendChild(right);
          container.appendChild(row);
        }
      });
      return container;
    }

    function confirmCreateAppointment(especialista, dateISO, time){
      const user = getCurrentUser();
      if(!user){ alert('Faça login para agendar.'); return; }
      const avail = getAvailabilityForSpecialistOnDate(especialista, dateISO);
      if(!avail.includes(time)){ alert('Horário já ocupado. Tente outro horário.'); return; }
      if(!confirm(`Confirma agendar com ${especialista.nome} em ${formatDateDDMMYYYY(dateISO)} às ${time}?`)) return;

      const ags = read(LS.AG);
      const novo = {
        id: genId(),
        pacienteId: user.id,
        pacienteNome: user.nome,
        pacienteCpf: user.cpf,
        pacienteSus: user.sus,
        especialistaId: especialista.id,
        especialistaNome: especialista.nome,
        especialidade: especialista.especialidade,
        data: dateISO,
        hora: time,
        createdAt: nowISO(),
        status: 'Pendente',
        agendadoPorGestor: false,
        clinicSnapshot: user.clinicAssigned || {}
      };
      ags.push(novo); write(LS.AG, ags);
      addHistory('agendamento','Usuário',`Agendamento criado pelo usuário: ${user.nome}`, { agendamento: novo });

      const pacs = read(LS.PAC); const pidx = pacs.findIndex(p => p.id === user.id);
      if(pidx >= 0){
        pacs[pidx].notifications = pacs[pidx].notifications ||[];
        pacs[pidx].notifications.push({ id: genId(), tipo:'agendamento', titulo:'Agendamento Criado (Pendente)', mensagem:`Sua solicitação com ${especialista.nome} para ${formatDateDDMMYYYY(dateISO)} ${time} aguarda confirmação.`, createdAt: nowISO() });
        write(LS.PAC, pacs);
      }

      alert('Agendamento criado (Pendente). O gestor precisará confirmar. Um comprovante será exibido.');
      openTicketModal(novo);
      renderVagasPanelForUser();
      renderMyAppointments();
    }

    function openTicketModal(ag){
      const overlay = document.getElementById('ticketModal');
      const body = document.getElementById('ticketBody');
      const cfg = JSON.parse(localStorage.getItem(LS.CFG) || '{}');
      body.innerHTML = `<div style="padding:12px;border-radius:8px;border:1px dashed var(--border)">
        <div style="font-weight:800">${cfg.nomeClinica || (ag.clinicSnapshot && ag.clinicSnapshot.nomeClinica) || ''}</div>
        <div class="small">${cfg.endereco || (ag.clinicSnapshot && ag.clinicSnapshot.endereco) || ''} • ${cfg.telefone || (ag.clinicSnapshot && ag.clinicSnapshot.telefone) || ''}</div>
        <hr>
        <div><strong>Criado em:</strong> ${formatDateTime(ag.createdAt)} • <strong>${ag.status}</strong></div>
        <div><strong>Agendado por:</strong> ${ag.agendadoPorGestor ? 'Gestor' : 'Usuário'}</div>
        <div><strong>Nome:</strong> ${ag.pacienteNome}</div>
        <div><strong>CPF:</strong> ${formatCPFDisplay(ag.pacienteCpf)}</div>
        <div><strong>Cartão SUS:</strong> ${formatSUSDisplay(ag.pacienteSus)}</div>
        <div><strong>Data da Consulta:</strong> ${formatDateDDMMYYYY(ag.data)}</div>
        <div><strong>Hora:</strong> ${ag.hora}</div>
        <div><strong>Especialidade:</strong> ${ag.especialidade}</div>
        <div><strong>Especialista:</strong> ${ag.especialistaNome}</div>
        ${ag.status === 'Cancelado' && ag.cancelReason ? `<div style="margin-top:8px"><strong>Motivo do Cancelamento:</strong> ${ag.cancelReason}</div>` : ''}
      </div>`;
      overlay.classList.add('show');
      document.getElementById('btnPrintTicket').onclick = () => {
        const win = window.open('','PRINT','height=700,width=900');
        win.document.write('<html><head><title>Comprovante</title>');
        win.document.write('<style>body{font-family:Arial,Helvetica,sans-serif;padding:20px} .small{font-size:12px;color:#444} </style>');
        win.document.write('</head><body>');
        win.document.write(document.getElementById('ticketBody').innerHTML);
        win.document.write('</body></html>');
        win.document.close();
        win.focus();
        win.print();
      };
      document.getElementById('btnCloseTicket').onclick = () => overlay.classList.remove('show');
    }

    function renderMyAppointments(filters = {}){ 
      const tbody = document.getElementById('myAgendamentosTbody');
      tbody.innerHTML = '';
      const user = getCurrentUser();
      if(!user){ tbody.innerHTML = '<tr><td colspan="6" class="small">Faça login para ver seus agendamentos.</td></tr>'; return; }
      let ags = read(LS.AG).filter(a => a.pacienteId === user.id).sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
      if(filters.from) ags = ags.filter(a => a.data >= filters.from);
      if(filters.to) ags = ags.filter(a => a.data <= filters.to);
      if(!ags.length){ tbody.innerHTML = '<tr><td colspan="6" class="small">Nenhum agendamento encontrado para o período.</td></tr>'; return; }
      ags.forEach(a => {
        const tr = document.createElement('tr');
        const cancelReasonHTML = (a.status === 'Cancelado' && a.cancelReason) 
            ? `<div class="small muted" style="margin-top:4px;">Motivo: ${a.cancelReason}</div>` 
            : '';
        tr.innerHTML = `<td>${a.especialidade}</td>
          <td>${a.especialistaNome}</td>
          <td>${formatDateDDMMYYYY(a.data)}</td>
          <td>${a.hora}</td>
          <td>
            <span class="status ${a.status === 'Confirmado' ? 'confirmed' : a.status === 'Cancelado' ? 'canceled' : 'pending'}">${a.status}</span>
            ${cancelReasonHTML}
          </td>
          <td class="actions">
            <button class="btn-blue" data-print="${a.id}">Imprimir</button>
            ${a.status !== 'Cancelado' ? `<button class="btn-danger" data-cancel="${a.id}">Cancelar</button>` : ''}
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('[data-print]').forEach(b => b.addEventListener('click', e => {
        const id = e.currentTarget.dataset.print;
        const ag = read(LS.AG).find(x => x.id === id);
        if(ag) openTicketModal(ag);
      }));
      tbody.querySelectorAll('[data-cancel]').forEach(b => b.addEventListener('click', e => {
        const id = e.currentTarget.dataset.cancel;
        if(!confirm('Deseja cancelar este agendamento?')) return;
        const agsAll = read(LS.AG); const idx = agsAll.findIndex(x => x.id === id);
        if(idx < 0) return alert('Agendamento não encontrado.');
        
        const ag = agsAll[idx];
        ag.status = 'Cancelado';
        ag.cancelReason = 'Cancelado pelo paciente';
        
        write(LS.AG, agsAll);
        addHistory('confirmacao','Usuário',`Agendamento cancelado pelo usuário: ${ag.pacienteNome}`, { agendamento: ag });

        const pacs = read(LS.PAC); const p = pacs.find(px => px.id === ag.pacienteId);
        if(p){
          const pidx = pacs.findIndex(px => px.id === p.id);
          pacs[pidx].notifications = pacs[pidx].notifications || [];
          pacs[pidx].notifications.push({ id: genId(), tipo:'agendamento', titulo:'Agendamento cancelado', mensagem:`Você cancelou sua consulta em ${formatDateDDMMYYYY(ag.data)} às ${ag.hora}.`, createdAt: nowISO() });
          write(LS.PAC, pacs);
        }
        renderMyAppointments({ from: document.getElementById('filterFrom').value, to: document.getElementById('filterTo').value });
        alert('Agendamento cancelado e vaga redisponibilizada.');
      }));
    }

    document.getElementById('btnFilterMy').addEventListener('click', ()=>{
      const from = document.getElementById('filterFrom').value;
      const to = document.getElementById('filterTo').value;
      renderMyAppointments({ from, to });
    });
    document.getElementById('btnClearMy').addEventListener('click', ()=>{
      document.getElementById('filterFrom').value=''; document.getElementById('filterTo').value=''; renderMyAppointments();
    });

    function renderUserHistory(filters = {}){
      const container = document.getElementById('histUserList');
      container.innerHTML = '';
      const user = getCurrentUser();
      if(!user){ container.innerHTML = '<div class="small">Faça login para ver histórico.</div>'; return; }
      let list = read(LS.HIST).slice().sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
      list = list.filter(entry => {
        if (entry.actor === 'Gestor') {
            if (entry.payload && entry.payload.agendamento && entry.payload.agendamento.pacienteId === user.id) return true;
            if (entry.payload && entry.payload.paciente && entry.payload.paciente.id === user.id) return true;
            return false; 
        }
        if (entry.actor === 'Usuário') {
            if (entry.payload && entry.payload.agendamento && entry.payload.agendamento.pacienteId === user.id) return true;
            if (entry.payload && entry.payload.paciente && entry.payload.paciente.id === user.id) return true;
        }
        return false;
      });
      if(filters.from) list = list.filter(l => l.timestamp.slice(0,10) >= filters.from);
      if(filters.to) list = list.filter(l => l.timestamp.slice(0,10) <= filters.to);
      if(!list.length){ container.innerHTML = '<div class="small">Nenhum registro no histórico para o período.</div>'; return; }

      list.forEach(entry => {
        const ts = formatDateTime(entry.timestamp);
        let text = `Criado em: ${ts}\nAção: ${entry.summary}`;
        if(entry.type === 'agendamento' && entry.payload && entry.payload.agendamento){
          const ag = entry.payload.agendamento;
          text += `\nNome: ${ag.pacienteNome}\nCPF: ${formatCPFDisplay(ag.pacienteCpf)} • Cartão SUS: ${formatSUSDisplay(ag.pacienteSus)}\nData: ${formatDateDDMMYYYY(ag.data)} • Hora: ${ag.hora}\nEspecialidade: ${ag.especialidade} • Especialista: ${ag.especialistaNome}`;
        }
         if(entry.type === 'confirmacao' && entry.payload && entry.payload.agendamento){
          const ag = entry.payload.agendamento;
          text += `\nConsulta: ${ag.especialidade} com ${ag.especialistaNome}\nData: ${formatDateDDMMYYYY(ag.data)} às ${ag.hora}`;
          if(ag.cancelReason) text += `\nMotivo: ${ag.cancelReason}`;
        }
        text += '\n\n'; 
        const pre = document.createElement('pre');
        pre.className = 'history';
        pre.textContent = text;
        container.appendChild(pre);
      });
    }

    document.getElementById('btnAplicarHistUser').addEventListener('click', ()=>{
      renderUserHistory({ from: document.getElementById('histFrom').value, to: document.getElementById('histTo').value });
    });
    document.getElementById('btnLimparHistUser').addEventListener('click', ()=>{
      document.getElementById('histFrom').value=''; document.getElementById('histTo').value=''; renderUserHistory();
    });

    document.getElementById('btnSolicitarAlteracao').addEventListener('click', ()=>{
      const user = getCurrentUser();
      if(!user) return alert('Faça login.');
      addHistory('paciente','Usuário',`Solicitação de alteração de dados do paciente: ${user.nome}`, { pacienteId: user.id, paciente: user });
      alert('Solicitação enviada à clínica (Caso seja urgente, procure a clinica a qual você é atendido(a).');
    });

    document.getElementById('btnCloseVagasUser').addEventListener('click', ()=> document.getElementById('vagasModal').classList.remove('show'));
    function comunicadosElegiveisParaUsuario(){
      const user = getCurrentUser(); if(!user) return [];
      const cfg = JSON.parse(localStorage.getItem(LS.CFG) || '{}');
      const coms = read(LS.COM);
      return coms.filter(c => {
        if (!c.setor) return true; 
        return c.setor === user.setor;
      }).sort((a,b)=> new Date(b.createdAt||b.data||0) - new Date(a.createdAt||a.data||0));
    }
    
    function getNotificationsForUser() {
        const user = getCurrentUser();
        if(!user) return [];
        const pacs = read(LS.PAC);
        const currentUserData = pacs.find(p => p.id === user.id);
        return (currentUserData.notifications || []).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
    }

    function refreshComunicadosBadge(){
      const user = getCurrentUser(); if(!user) return;
      const notifications = getNotificationsForUser();
      const lidos = user.comunicadosLidos || [];
      const naoLidos = notifications.filter(n => !lidos.includes(n.id));
      const badge = document.getElementById('comBadge');
      if(naoLidos.length){ badge.textContent = naoLidos.length; badge.style.display = 'inline-block'; }
      else { badge.style.display = 'none'; }
    }

    function checkNewComunicadosAndNotify(){
      refreshComunicadosBadge(); 
    }

    function renderComunicadosPage(){
      const user = getCurrentUser();
      const box = document.getElementById('comList');
      box.innerHTML = '';
      if(!user){ box.innerHTML = '<div class="small">Faça login para visualizar comunicados.</div>'; return; }
      const notifications = getNotificationsForUser();
      const lidos = user.comunicadosLidos || [];
      if(!notifications.length){ box.innerHTML = '<div class="small">Nenhum comunicado no momento.</div>'; return; }
      notifications.forEach(n=>{
        const isLido = lidos.includes(n.id);
        const card = document.createElement('div');
        card.className = 'card';
        card.style.padding = '12px';
        card.innerHTML =
          `<div style="display:flex;justify-content:space-between;align-items:center;">
             <div><strong>${n.titulo || 'Comunicado'}</strong> <span class="small muted">• ${formatDateTime(n.createdAt)}</span></div>
             <div>${isLido ? '<span class="small confirmed">Lido</span>' : '<span class="small pending">Não Lido</span>'}</div>
           </div>
           <div style="margin-top:6px">${n.mensagem || ''}</div>
           <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
             ${isLido ? '' : '<button class="btn" data-lido="'+n.id+'">Marcar como lido</button>'}
           </div>`;
        box.appendChild(card);
      });

      box.querySelectorAll('[data-lido]').forEach(b=>{
        b.addEventListener('click', e=>{
          const id = e.currentTarget.getAttribute('data-lido');
          const pacs = read(LS.PAC);
          const idx = pacs.findIndex(p=>p.id===user.id);
          pacs[idx].comunicadosLidos = pacs[idx].comunicadosLidos || [];
          if(!pacs[idx].comunicadosLidos.includes(id)) pacs[idx].comunicadosLidos.push(id);
          write(LS.PAC, pacs);
          renderComunicadosPage();
          refreshComunicadosBadge();
        });
      });
    }

    function showPage(page){
      const pages = ['dashboard','comunicados','agendar','meus-agendamentos','meu-perfil','historico','contato'];
      pages.forEach(p => { const el = document.getElementById(p); if(el) el.style.display = (p === page) ? 'block' : 'none'; });
      document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
      const link = document.querySelector(`.nav a[data-page="${page}"]`);
      if(link) link.classList.add('active');
      if(page === 'dashboard') { renderVagasPanelForUser(); populateEspecialidadesSelect(); }
      if(page === 'comunicados') { renderComunicadosPage(); }
      if(page === 'meus-agendamentos') renderMyAppointments();
      if(page === 'meu-perfil') renderPerfilUser();
      if(page === 'historico') renderUserHistory();
      if(page === 'contato') renderClinicContact();
    }
    document.querySelectorAll('.nav a[data-page]').forEach(a => a.addEventListener('click', e => { e.preventDefault(); showPage(a.dataset.page); }));

    function applyMasksOnInputs(){
      try {
        document.querySelectorAll('input').forEach(inp => {
          const id = (inp.id || '').toLowerCase();
          if(id.includes('cpf')) IMask(inp, { mask: '000.000.000-00' });
          if(id.includes('sus')) IMask(inp, { mask: '000.0000.0000.0000' });
        });
      } catch(e){}
    }

    function boot(){
      initDefaults();
      populateBairrosSelect();
      renderClinicContact();
      applyMasksOnInputs();

      const session = localStorage.getItem(LS.SESSION);
      if(!session){
        document.getElementById('app').style.display = 'flex';
        document.getElementById('app').classList.add('blocked');
        document.getElementById('loginScreen').style.display = 'flex';
      } else {
        loadUserSessionAndShowApp();
      }
      setInterval(()=>{ const s = getCurrentUser(); if(s){ checkNewComunicadosAndNotify(); } }, 10000);
    }
    window.addEventListener('DOMContentLoaded', boot);
    window._userApp = { read, write, LS, genId, getCurrentUser, findAvailabilityForSpecialtyNextWeek };
  </script>
</body>
</html>